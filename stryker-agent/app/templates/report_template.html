<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Mutation Test Report</title>
    <!-- 1. Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 2. Prism.js for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; color: #333; }
        .container { max-width: 1200px; margin: 2em auto; padding: 0 2em; }
        header { background-color: #fff; padding: 1.5em 2em; border-bottom: 1px solid #ddd; margin-bottom: 2em; }
        h1, h2, h3 { color: #1f2937; font-weight: 600; }
        h1 { font-size: 2em; }
        h2 { font-size: 1.5em; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5em; margin-top: 2em; }
        .card { background-color: #fff; border-radius: 8px; padding: 1.5em; margin-bottom: 1.5em; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .error { background-color: #fff1f2; border-left: 5px solid #f43f5e; }
        .success { background-color: #f0fdf4; border-left: 5px solid #22c55e; }
        .summary-grid { display: flex; flex-wrap: wrap; gap: 1.5em; }
        .summary-card { flex: 1; min-width: 200px; text-align: center; }
        .summary-card .value { font-size: 2.5em; font-weight: 700; }
        .summary-card .label { font-size: 1em; color: #6b7280; }
        .charts-grid { display: flex; gap: 1.5em; margin-top: 1.5em; flex-wrap: wrap; }
        .chart-container { flex: 1; min-width: 300px; height: 350px; }
        pre[class*="language-"] { border-radius: 6px; }
        code[class*="language-"] { font-family: "Fira Code", "Courier New", monospace; }
        .mutation-details { display: grid; grid-template-columns: 1fr 1fr; gap: 1em; }
        .mutation-details pre { margin-top: 0.5em; }
        hr { border: 0; height: 1px; background-color: #e5e7eb; margin: 1.5em 0; }
    </style>
</head>
<body>
    <header>
        <h1>AI Mutation Test Agent Report</h1>
    </header>

    <div class="container">
        {% if state.error_message %}
        <div class="card error">
            <h2>Operation Failed</h2>
            <p>The agent encountered an error:</p>
            <pre><code>{{ state.error_message }}</code></pre>
        </div>
        {% else %}
        
        <!-- Summary Section -->
        <div class="card">
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="value" style="color: #3b82f6;">{{ "%.2f"|format(state.mutation_score) }}%</div>
                    <div class="label">Mutation Score</div>
                </div>
                <div class="summary-card">
                    <div class="value" style="color: #ef4444;">{{ state.mutation_stats.survived }}</div>
                    <div class="label">Survived</div>
                </div>
                <div class="summary-card">
                    <div class="value" style="color: #22c55e;">{{ state.mutation_stats.killed }}</div>
                    <div class="label">Killed</div>
                </div>
                <div class="summary-card">
                    <div class="value" style="color: #8b5cf6;">{{ state.generated_tests|length }}</div>
                    <div class="label">New Tests Generated</div>
                </div>
            </div>
            {% if state.new_pr_url %}
            <p style="margin-top: 1.5em;"><strong>Corrective PR Created:</strong> <a href="{{ state.new_pr_url }}" target="_blank">{{ state.new_pr_url }}</a></p>
            {% endif %}
        </div>

        <!-- Charts Section -->
        <h2>Visual Analysis</h2>
        <div class="card">
            <div class="charts-grid">
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
                {% if state.survived_by_mutator %}
                <div class="chart-container">
                    <canvas id="mutatorChart"></canvas>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Details Section -->
        {% if state.survived_mutations %}
        <h2>Survived Mutations & Generated Tests</h2>
        {% for mutation, test in zip(state.survived_mutations, state.generated_tests) %}
        <div class="card">
            <h3>Mutation in <code>{{ mutation.file_path }}</code> (Line {{ mutation.location.start.line }})</h3>
            <p><strong>Mutator:</strong> <code>{{ mutation.mutator_name }}</code></p>
            <div class="mutation-details">
                <div>
                    <p><strong>Original Code (Killed):</strong></p>
                    <pre><code class="language-csharp">{{ mutation.original_code }}</code></pre>
                </div>
                <div>
                    <p><strong>Mutated Code (Survived):</strong></p>
                    <pre><code class="language-csharp">{{ mutation.mutated_code }}</code></pre>
                </div>
            </div>
            <hr>
            <p><strong>Generated Test for <code>{{ test.target_test_file }}</code>:</strong></p>
            <pre><code class="language-csharp">{{ test.generated_test_code }}</code></pre>
        </div>
        {% endfor %}
        {% endif %}

        {% endif %}
    </div>

    <!-- 3. Prism.js and Chart.js Initialization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Data from Python state
            const stats = {{ state.mutation_stats | tojson }};
            const survivedByMutator = {{ state.survived_by_mutator | tojson }};

            // Chart 1: Mutation Status Breakdown
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Killed', 'Survived', 'No Coverage', 'Compile Error'],
                    datasets: [{
                        label: 'Mutation Status',
                        data: [stats.killed, stats.survived, stats.no_coverage, stats.compile_error],
                        backgroundColor: ['#22c55e', '#ef4444', '#f97316', '#6b7280'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Overall Mutation Status' }
                    }
                }
            });

            // Chart 2: Survived Mutators Breakdown
            if (survivedByMutator && Object.keys(survivedByMutator).length > 0) {
                const mutatorCtx = document.getElementById('mutatorChart').getContext('2d');
                new Chart(mutatorCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(survivedByMutator),
                        datasets: [{
                            label: 'Count',
                            data: Object.values(survivedByMutator),
                            backgroundColor: '#8b5cf6',
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'Survived Mutator Types' }
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
